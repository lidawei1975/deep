README 
This file describes the computer software implementation of DEEP Picker, which is the artificial neural network based 2D NMR spectral peak picking and deconvolution tool as described in the manuscript “DEEP Picker is a Deep Neural Network for Accurate Deconvolution of Complex Two-Dimensional NMR Spectra ” (Li et al. (2021), submitted for publication) and nonlinear peak fitter. 

DEEP Picker predicts every 2D cross-peak locally without taking into account the behavior of spectral data points that are further away. To further improve consistency of all the predicted peaks, the peak fitter can perform a nonlinear least squares fit of all peaks simultaneously, using the results returned by DEEP Picker as a starting point. The nonlinear peak fitter can read in a starting peak list generated by other software too. Because nonlinear least square peak fitting cannot guarantee that the identified chi2 minimum is the global minimum, the availability of a good starting point is vital for the best results. Based on our experience with DEEP Picker, we found that it provides under many different circumstances an excellent starting point for the fully quantitative fitting of the peak parameters of individual peaks. The nonlinear peak fitter can fit pseudo-3D spectra too. For pseudo-3D spectral fitting, the fitted peaks have identical peak positions and line shapes and free varying peak amplitudes across all 2D planes.


INSTALLATION
DEEP Picker and peak fitter can be built using CMAKE on any platform with C++ (V11 or newer). 
DEEP Picker depends on EIGEN version 3 (https://eigen.tuxfamily.org). The peak fitter depends on Ceres-solver (http://ceres-solver.org/).

WEB SERVER VERSION of DEEP Picker
As an alternative to the above software, we also provide a web server version at http://spin.ccic.osu.edu/index.php/deep_picker,  which draws a contour plot of the input spectrum with all picked peaks indicated in the spectrum. This allows the visual assessment of the performance of DEEP picker. Note: the web server also includes a peak fitting function in addition to peak picking, which uses the peaks picked by DEEP Picker as starting points for the fitting of final peak positions, peak shapes, and amplitudes. This web server, which is most convenient both for the demonstration and the application of DEEP Picker, allows the users to download the picked and fitted peak lists and the reconstructed spectrum for further use in their NMR spectral analysis workflow.  

Spectral processing of input spectra
The following are the spectral processing steps that should be followed carefully as they are important for the performance of DEEP Picker.
1. The number of points per peak (PPP), which is the number of data points that sample the peak’s full width at half height (FWHH), is allowed to vary either from 6 to 20 points or from 4 to 12 points, whereby the former is typical for protein spectra and the latter for metabolomics spectra. The Lorentzian component of the assumed Voigt peak shape can vary from 0%, corresponding to a pure Gaussian lineshape, to 100%, corresponding to a pure Lorentzian lineshape. Typically, 3-fold of zero-filling is required to reach the PPPs mentioned above.
2. We strongly recommend to use the 2pi-Kaiser window function for apodization in the NMRPipe software with the command “SP -off 0.5 -end 0.896 -pow 3.684”. The resulting peak shapes can then be modeled in all dimensions with good accuracy by a Voigt profile that combines variable amounts of Lorentzian vs. Gaussian character.

Command line arguments of DEEP picker
noise_level: the program uses 1.48 times the median absolute deviation of an empty (i.e. peak-free) region of the spectrum to automatically estimate the noise level, which is used as default (default is used when noise_level is set to 0). Users can also set the noise level manually using this command line argument.
scale: minimal peak amplitude cutoff defined as a multiple of the noise level. The default value is 5.5. Peaks with amplitudes below this value will not be picked, but they are still shown in spectrum. 
scale2: noise floor cutoff defined as a multiple of noise level. Prior to peak picking, spectral points will be set to 0 if their amplitude is lower than this cutoff. Default value is 3.0. 
in: input file name. The program accepts input files with either nmrpipe (.ft2), sparky (.ucsf), Topspin ASCII format (.txt) or Mnova (.csv) formats. The program uses file extension to recognize the file format. The default is input.ft2.
out: filename of output peak list. Multiple files can be provided. The program can write output in both the nmrPipe .tab and Sparky .list format. The program uses the file extension of the output filename to decide in which format to write the output. The returned peak list files can be directly imported into the corresponding software to view the spectrum along with the picked peaks allowing the visual assessment of the performance of DEEP picker. 
model: ANN model selection according to typical PPP range of spectrum (see above). It is either 1 (6 < PPP < 20 (typical for protein spectra)) or 2 (4 < PPP < 12 (typical for metabolomics spectra)). Default is 1.


Command line arguments of nonlinear peak fitter:
method: peak line shape in peak fitting. The program supports two types of peak line shapes: Gaussian and Voigt. 
noise_level: the program uses 1.48 times the median absolute deviation of an empty (i.e. peak-free) region of the spectrum to automatically estimate the noise level,which is used as default (default is used when noise_level is set to 0). Users can also set the noise level manually using this command line argument.  
scale: minimal peak amplitude cutoff defined as a multiple of the noise level. The default value is 5.5. Peaks with amplitudes below this value will not be picked, but they are still shown in spectrum. 
scale2: noise floor cutoff defined as a multiple of noise level. Prior to peak picking, spectral points will be set to 0 if their amplitude is lower than this cutoff. Default value is 3.0. 
in: input file name. The program accepts input files with either nmrpipe (.ft2), sparky (.ucsf), Topspin ASCII format (.txt) or Mnova (.csv) formats. The program uses file extension to recognize the file format. The default is input.ft2.
out: filename of output peak list. Multiple files can be provided. The program can write output in both the nmrPipe .tab and Sparky .list format. The program uses the file extension of the output filename to decide in which format to write the output(s). The returned peak list files can be directly imported into the corresponding visualization software to view the spectrum together with the picked peaks allowing a visual assessment of the performance. 
recon: "yes" or "no". If "yes", the program will write both the reconstructed spectrum, which is generated using the fitted peaks, and the differential spectrum as output. If "no", the program does not write any output spectra.  
maxround: maximal number of iterations of the nonlinear peak fitting. Default is 50. 
wx: user provides full width at half height (FWHH) of peaks along the direct spectral dimension in units of ppm. The program uses this value to define when peaks overlap and need to be fitted together. Default value is 0, which means that the program will use FWHH calculated from peak parameters in the input peak list file.
wy: same as wx but for the indirect spectral dimension.


CITATION:
If you found DEEP Picker and/or nonlinear peak fitter useful, please cite our publication(s):
DEEP Picker is a Deep Neural Network for Accurate Deconvolution of Complex Two-Dimensional NMR Spectra, D.-W. Li, A.L. Hansen, C. Yuan, L. Bruschweiler-Li, R. Brüschweiler (2021), submitted for publication.
