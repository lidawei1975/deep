# Deep Picker Suite

This file describes the computer software implementation of DEEP Picker, which is the artificial neural network based 2D NMR spectral peak picking and deconvolution tool as described in the manuscript “DEEP Picker is a Deep Neural Network for Accurate Deconvolution of Complex Two-Dimensional NMR Spectra ” (Li et al. (2021)) and nonlinear peak fitter. 

DEEP Picker predicts every 2D cross-peak locally without taking into account the behavior of spectral data points that are further away. To further improve consistency of all the predicted peaks, the peak fitter can perform a nonlinear least squares fit of all peaks simultaneously, using the results returned by DEEP Picker as a starting point. The nonlinear peak fitter can read in a starting peak list generated by other software too. Because nonlinear least square peak fitting cannot guarantee that the identified chi2 minimum is the global minimum, the availability of a good starting point is vital for the best results. Based on our experience with DEEP Picker, we found that it provides under many different circumstances an excellent starting point for the fully quantitative fitting of the peak parameters of individual peaks. The nonlinear peak fitter can fit pseudo-3D spectra too. For pseudo-3D spectral fitting, the fitted peaks have identical peak positions and line shapes and free varying peak amplitudes across all 2D planes.

DEEP Pikcer 1D and Voigt Fitter 1D are similar but are for 1D spectra.


# INSTALLATION
DEEP Picker and peak fitter can be built using CMAKE on any platform with C++ (V11 or newer). 
DEEP Picker depends on EIGEN version 3 (https://eigen.tuxfamily.org). The peak fitter depends on Ceres-solver (http://ceres-solver.org/).

Step by step guide

Linux System:

Install Ceres-solver: Begin by installing Ceres-solver, a nonlinear optimization library. Follow the installation guide available at http://ceres-solver.org/installation.html. Note that Ceres-solver has its own dependencies, so make sure to install them as well according to the Ceres-solver guide.

Download the source code: Download the Deep-picker source code and unzip it into a folder on your Linux system, such as /home/user-name/deep-picker.

Create a build directory: Open a terminal and create a build directory by executing the following command: mkdir /home/user-name/build-deep-picker

Navigate to the build directory: Change to the build directory using the following command: cd /home/user-name/build-deep-picker

Generate build files using CMake: Run CMake in the build directory, specifying the location of the Deep-picker source code by executing the following command: cmake ../deep-picker

Build Deep-picker: Once CMake has generated the necessary build files, use the make command to build Deep-picker: make

Run Deep-picker: After the build process completes successfully, you can find the executables in the /home/user-name/build-deep-picker folder. To run Deep-picker, type the following command: /home/user-name/build-deep-picker/deep_picker -h

Combined above codes:

```
mkdir /home/user-name/build-deep-picker
cd /home/user-name/build-deep-picker
cmake ../deep-picker
make
```

Windows (Mac) System:

Install CMake GUI: Download and install CMake GUI, which is available at https://cmake.org/download/. Follow the installation instructions provided for your specific operating system.

Generate project file: Open CMake GUI and specify the Deep-picker source code directory as the "Source Code" path. Choose a build directory (e.g., /path/to/build-deep-picker) as the "Build" path.

Configure project: Click on the "Configure" button in CMake GUI and select the appropriate generator for your development environment (e.g., MS Visual Studio for Windows or Apple Xcode for Mac).

Build Deep-picker: Once the configuration process completes without errors, click on the "Generate" button to create the project files for your chosen development environment. Open the generated project files using MS Visual Studio or Apple Xcode and build Deep-picker from within the respective IDE.

Note: The exact steps may vary depending on your system configuration


# WEB SERVER VERSION of DEEP Picker
As an alternative to the above software, we also provide a web server version at http://spin.ccic.osu.edu/index.php/deep_picker,  which draws a contour plot of the input spectrum with all picked peaks indicated in the spectrum. This allows the visual assessment of the performance of DEEP picker. Note: the web server also includes a peak fitting function in addition to peak picking, which uses the peaks picked by DEEP Picker as starting points for the fitting of final peak positions, peak shapes, and amplitudes. This web server, which is most convenient both for the demonstration and the application of DEEP Picker, allows the users to download the picked and fitted peak lists and the reconstructed spectrum for further use in their NMR spectral analysis workflow.  

# Spectral processing of input spectra
The following are the spectral processing steps that should be followed carefully as they are important for the performance of DEEP Picker.

1. The number of points per peak (PPP), which is the number of data points that sample the peak’s full width at half height (FWHH), is allowed to vary either from 6 to 20 points or from 4 to 12 points, whereby the former is typical for protein spectra and the latter for metabolomics spectra. The Lorentzian component of the assumed Voigt peak shape can vary from 0%, corresponding to a pure Gaussian lineshape, to 100%, corresponding to a pure Lorentzian lineshape. 

2. Update 2024: with the introduction of auto_ppp function, it become less critical to set optimal peak width. However, auto_ppp only works when ppp is at least 4 points. In practice, set zf to 2 folder is usually fine.

3. We strongly recommend to use the 2pi-Kaiser window function for apodization in the NMRPipe software with the command “SP -off 0.5 -end 0.896 -pow 3.684”. The resulting peak shapes can then be modeled in all dimensions with good accuracy by a Voigt profile that combines variable amounts of Lorentzian vs. Gaussian character.

# A typical work flow

1. Run deep_picker to pick peaks, e.g. run "./deep_picker -in test.ft2" to generate a file named peaks.tab

2. Run voigt_fit to optimize peaks, e.g., run "./voigt_fit -in test.ft2 -peak_in peaks.tab -out fitted.tab" to get an optimized peaks file named "fitted.tab"

# How to use Deep Picker
Command line arguments of DEEP picker program "deep_picker"

1. noise_level: the program uses 1.48 times the median absolute deviation of an empty (i.e. peak-free) region of the spectrum to automatically estimate the noise level, which is used as default (default is used when noise_level is set to 0). Users can also set the noise level manually using this command line argument.

2. scale: minimal peak amplitude cutoff defined as a multiple of the noise level. The default value is 5.5. Peaks with amplitudes below this value will not be picked, but they are still shown in spectrum. 

3. scale2: noise floor cutoff defined as a multiple of noise level. Prior to peak picking, spectral points will be set to 0 if their amplitude is lower than this cutoff. Default value is 3.0. 

4. in: input file name. The program accepts input files with either nmrpipe (.ft2), sparky (.ucsf), Topspin ASCII format (.txt) or Mnova (.csv) formats. The program uses file extension to recognize the file format. The default is input.ft2.

5. out: filename of output peak list. Multiple files can be provided. The program can write output in both the nmrPipe .tab and Sparky .list format. The program uses the file extension of the output filename to decide in which format to write the output. The returned peak list files can be directly imported into the corresponding software to view the spectrum along with the picked peaks allowing the visual assessment of the performance of DEEP picker. 

6. model: ANN model selection according to typical PPP range of spectrum (see above). It is either 1 (6 < PPP < 20 (typical for protein spectra)) or 2 (4 < PPP < 12 (typical for metabolomics spectra)). Default is 1.

7. auto_ppp: yes or no. If yes, the program will adjust PPP automatically using cubic spline interpolation method. Unless you have a good reason, this should always be set to yes.

8. negative: yes or no. If yes, Deep Picker will also pick negative peaks. 

# How to use Voigt Fitter
Command line arguments of nonlinear peak fitter program "voigt_fit"

1. method: peak line shape in peak fitting. The program supports two types of peak line shapes: Gaussian and Voigt. Because Gaussian is a special case of Voigt, it is generally recommended to use Voigt, unless you know there is no Lorentzian component in your peak line shape. Voigt fitting is more expensive then Gaussian fitting.

2. noise_level: the program uses 1.48 times the median absolute deviation of an empty (i.e. peak-free) region of the spectrum to automatically estimate the noise level,which is used as default (default is used when noise_level is set to 0). Users can also set the noise level manually using this command line argument.  

3. scale: minimal peak amplitude cutoff defined as a multiple of the noise level. The default value is 5.5. Peaks with amplitudes below this value will not be picked, but they are still shown in spectrum. 

4. scale2: noise floor cutoff defined as a multiple of noise level. Prior to peak picking, spectral points will be set to 0 if their amplitude is lower than this cutoff. Default value is 3.0. 

5. in: input file name. The program accepts input files with either nmrpipe (.ft2), sparky (.ucsf), Topspin ASCII format (.txt) or Mnova (.csv) formats. The program uses file extension to recognize the file format. The default is input.ft2. 

6. out: filename of output peak list. Multiple files can be provided. The program can write output in both the nmrPipe .tab and Sparky .list format. The program uses the file extension of the output filename to decide in which format to write the output(s). The returned peak list files can be directly imported into the corresponding visualization software to view the spectrum together with the picked peaks allowing a visual assessment of the performance. 

7. recon: "yes" or "no". If "yes", the program will write both the reconstructed spectrum, which is generated using the fitted peaks, and the differential spectrum as output. If "no", the program does not write any output spectra.  

8. maxround: maximal number of iterations of the nonlinear peak fitting. Default is 50. 

9. wx: user provides full width at half height (FWHH) of peaks along the direct spectral dimension in units of ppm. The program uses this value to define when peaks overlap and need to be fitted together. Default value is 0, which means that the program will use FWHH calculated from peak parameters in the input peak list file.

10. wy: same as wx but for the indirect spectral dimension.

Addtional options:
1. To run pseudo-3D peaks fitting, you can provide multiple input files like this: " -in test001.ft2 test002.ft2 test003.ft2" , where all peaks will have the same peak position, shape across all spectra but various peak heights. 

2. The program supports Monte Carlo type error analysis (Bootstrapping) to estimate accuracy of fitted peak parameters, caused by noise. To enable it, set "-n_err" to 5 or larger, which is the number of addtional rounds of fitting with artifical noise added. 

# Deep Picker 1D and Voigt Fitter 1D

These two programs (deep_picker_1d, peak_fit_1d ) are very similar to the above 2D version but are for 1D spectra. To list all command line arguments with explanation, run them with "-h" argument.

# CITATION:
If you found DEEP Picker and/or nonlinear peak fitter useful, please cite our publication(s):

1. DEEP Picker is a Deep Neural Network for Accurate Deconvolution of Complex Two-Dimensional NMR Spectra, D.-W. Li, A.L. Hansen, C. Yuan, L. Bruschweiler-Li, R. Brüschweiler; Nature Communications, 5229 (2021)

2. Fundamental and practical aspects of machine learning for the peak picking of biomolecular NMR spectra, Li, D.W.; Hansen, Alexandar L.; Yuan, Chunhua ;Bruschweiler-Li, Lei and Bruschweiler, R; J. Bio. NMR 76 (3), 49

3. DEEP Picker1D and Voigt Fitter1D: A versatile tool set for the automated quantitative spectral deconvolution of complex 1D NMR spectra, Da-Wei Li, Lei Bruschweiler-Li, Alexandar L. Hansen, and Rafael Brüschweiler; Magnetic Resonance, 4, 19-26 (2023)
